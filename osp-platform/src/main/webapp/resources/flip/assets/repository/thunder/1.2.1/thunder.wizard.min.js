/**
 * thunder v1.2.1
 * ===============================
 * Copyright (c) 2014 Far Eastone Telecommunications Co., Ltd.
 * All Rights Reserved.
 * build time: 2015-04-16 17:03:40 
 */
!function(a,b,c){"use strict";define("thunderWizard",["initConfig"],function(){var a=angular.module("thunder.wizard",[]);a.factory("wizardService",["$fetUI",function(){return{wizards:{},register:function(a){return a.$wizardView={},a.$wizardParams={},a},restore:function(a,b){var c=this.wizards[a];return c.restore(b)},save:function(){},reset:function(a){var b=this.wizards[a];b.reset()},bind:function(a){this.wizards[a.key]=a},unbind:function(a){this.wizards[a]=c},getCurrent:function(){},get:function(a){return this.wizards[a]||(this.wizards[a]={}),this.wizards[a]}}}]),a.factory("wizardErrorMessage",["$fetUI",function(){var a={};return a.W001="回存資料發生異常",a.W002="暫存資料發生異常",a.W003="Wizard Key值不存在",a.W004="Wizard Id值不存在",a.W005="未設定requireData的參數",a.W006="找不到wizard索引值",a.W007="找不到wizard群組索引值",a.W008="找不到Step的設定值(404)",a.W009="取得Step的設定值出現錯誤(500)",a.W010="WizardConfig未設定Step",a.W011="WizardConfig未設定儲存Step的URL API",a.W012="WizardConfig未設定回存Step的URL API",a.W013="WizardConfig.callbackUrl取存發生錯誤(500)",a}]),a.factory("$wizardAction",["$fetUI","httpService",function(a,b){return function(a,d,e,f,g,h){var i=0,j=function(){var a=0;return _.forEach(e,function(b){return"active"==b.active?!1:void a++}),e[a]},k=function(){return e[i]},l=function(a){var b=_.findIndex(e,function(b){return b.groupIndex==a});return e[b]},m=function(a){var b=[];return _.forEach(e,function(c){c.groupIndex==a&&b.push(c)}),b},n=function(b){var c=$('[name="wizard_'+a+"_"+b.index+'"]');c.find("a,button").addClass("disabled"),c.find("input").prop("readonly",!0).prop("disabled",!0),c.block({message:null,overlayCSS:{backgroundColor:"#fff",opacity:.2,cursor:"not-allowed"}})},o=function(b){var c=$('[name="wizard_'+a+"_"+b.index+'"]');c.find("a,button").removeClass("disabled"),c.find("input").prop("readonly",!1).prop("disabled",!1),c.unblock()},p=function(a){i=0,_.forEach(e,function(a,b){0===b?(a.state="A",a.selected="true"):a.state="V",a.isDone=!1,a.active="",a._hasCotent_==c}),a.setParams({}),a.setData({})},q={key:a,selectIndex:0,lock:function(){var a=e[this.selectIndex];"AD"===a.state&&(n(a),a.state="L")},unlock:function(){var a=e[this.selectIndex];"L"===a.state&&(o(a),a.state="AD")},reset:function(){p(this),f.triggerHandler("wizard.reset"),f.triggerHandler("wizard.begin")},next:function(a){var b=j();1==a?b=k():(i=b.index+1,i==e.length-1?e.length:i,b=e[i]),f.triggerHandler("wizard.choose",b)},done:function(a){function b(a){if(i=o.index,_.forEach(a,function(a){a.state="O",n(a),i++}),g.$wizardView=d.getData(),e.groupIndex==h)f.triggerHandler("wizard.end");else{e=k();var b=m(e.groupIndex);_.forEach(b,function(a){a.state="A"})}f.triggerHandler("wizard.done",{group:e.group,index:e.index,title:e.title})}function c(a){var b=!0;return 1==a.length?b:(_.forEach(a,function(a){return"A"==a.state?b=!1:void 0}),b)}var d=this,e=j(),l=m(e.groupIndex),o=l[0];if(1==l.length){if("O"==e.state||"OR"==e.state)return}else if("O"==o.state||"OR"==o.state)return;if(e)if(a===!0)e.isDone=!0,c(l)&&b(l);else{var p=!0;c(l)&&(e.isDone=!0,_.forEach(l,function(a){return a.isDone!==!0?p=!1:void 0}),this.lock(),p===!0&&b(l))}},save:function(){var c=k(),e=this.getParams(),g=d.saveUrl,h=this.getData(),i={wizardView:h,id:a,params:e,index:c.index,groupIndex:c.groupIndex};return g?b.post(g,{data:{data:i},headers:{"Content-Type":"application/json; charset=UTF-8"}})["catch"](function(a){f.triggerHandler("wizard.error",{code:"W002",error:a})})["finally"](function(){c.state="A"}):(c.state="A",void f.triggerHandler("wizard.error",{code:"W011"}))},restore:function(a){var c=d.restoreUrl,e={params:{wizardKey:a}};return p(this),c?b.get(c,e).then(function(a){var b=a.data,c=l(b.groupIndex);c.state="A",g.$wizardView=b.wizardView,i=c.index;for(var d=b.groupIndex-1;d>=1;d--){var e=m(d);_.forEach(e,function(a){a.state="OR",n(a)})}b.item=c,f.triggerHandler("wizard.restore",b)})["catch"](function(a){"404"==a.status?f.triggerHandler("wizard.error",{code:"W003",error:a}):f.triggerHandler("wizard.error",{code:"W001",error:a})}):void f.triggerHandler("wizard.error",{code:"W012"})},setData:function(a){g.$wizardView||(g.$wizardView={}),g.$wizardView=a},getData:function(){var a=d.initData||{},b=d.globalData||{},c=g.$wizardView||{};return 0==i?$.extend(b,a,c):$.extend(b,c)},setParams:function(a){g.$wizardView||(g.$wizardparams=a),g.$wizardParams=a},getParams:function(){var a=d.initParams||{},b=d.globalParams||{},c=g.$wizardParams||{};return 0==i?$.extend(b,a,c):$.extend(b,c)}};return q}}]),a.directive("fetWizard",["$fetUI","httpService","$compile","$timeout","wizardService","eventBusService","wizardErrorMessage","loggingService","$wizardAction","modalService",function(a,b,c,d,e,f,g,h,i,j){var k="fetWizard";return{name:k,scope:!0,restrict:"EA",replace:!0,priority:102,transclude:!0,template:"<div role=\"tabpanel\"><ul class=\"wizard\" role=\"tablist\"><li ng-repeat=\"item in $items track by $index\" ng-class=\"{active:(item.selected), editable:(item.state=='A' || item.state=='AD'|| item.state=='L'), 'read-only': (item.state=='O' || item.state=='OR'), disable: (item.state=='V')}\"><a wizard-step=\"wizard_{{$$wizardId}}_{{item.index}}\"   href=\"\" ng-click=\"$$select(item,true)\">{{item.title}}<span class=\"label label-default\"><i class=\"fa\" ng-class=\"{'fa-edit':(item.state=='A' || item.state=='AD'), 'fa-lock': (item.state=='O'  || item.state=='OR' || item.state=='L'), 'fa-ban': (item.state=='V')}\"></i></span></a></li></ul><div class=\"tab-content\"><div class=\"tab-pane fade in {{item.active}}\" ng-repeat=\"item in $items track by $index\" name=\"wizard_{{$$wizardId}}_{{item.index}}\"  >{{item.title}}</div><div></div></div></div>",compile:function(){return{post:function(f,l,m){var n=a.getScope(f,m,"sWizardConfig"),o=a.getExpression(f,m,"onWizardBegin"),p=a.getExpression(f,m,"onWizardEnd"),q=a.getExpression(f,m,"onWizardError"),r=a.getExpression(f,m,"onWizardReset"),s=a.getExpression(f,m,"onWizardDone"),t=a.getExpression(f,m,"onWizardSelect"),u=[],v=function(){var a=u[0];f.$items=u,l.triggerHandler("wizard.choose",a)},w=n.id||m.id||f.$id,x=0;f.$$wizardId=w,n.id||(n.id=w),u=[],angular.isArray(n.processes)&&(u=_.cloneDeep(n.processes));var y=_.uniq(_.pluck(u,"group")),z={};$.each(y,function(a,b){z[b]={},z[b].count=0});var A=function(){_.forEach(f.$items,function(a){a.active=""})},B=function(d,e,g,h){var i,j,k,m="";return a.uiBlock(l,!0),b.get(d,e).success(function(a){switch(i=a.type||"html",i=angular.lowercase(i),k=a,i){case"html":j="<div ng-include data-src=\"'"+a.url+"'\"></div>";break;case"iframe":j='<iframe width="100%"  src="'+a.url+'" ></iframe>';break;case"template":j="<div>"+a.content+"</div>"}return a}).error(function(){}).success(function(){"apppart"==i&&b.get(k.url,{}).success(function(b){b.config=b.config||{},b.config.$wizardId=w,b.config.$wizardView=b.config.$wizardView||{},f.$$appPartConfig=b,j='<div app-part src="$$appPartConfig" loadingeffect="\'false\'"></div>',m=c(j)(f),l.find('[name="'+g+'"]').html(m),h.state="AD",a.uiBlock(l,!1)}).error(function(){})}).success(function(b){return m=c(j)(f),l.find('[name="'+g+'"]').html(m),h.state="AD",a.uiBlock(l,!1),b})};$.each(u,function(a,b){var c=b.group;c?(z[c].count++,z[c].count<2&&x++,b.groupIndex=x):(x++,b.groupIndex=x),b.index=a,b.data={},b.state=0!=a?"V":"A"}),f.$wizardAction=i(f.$$wizardId,n,u,l,f.$parent,x);var C=function(a,b){var c=!0;return a.require&&(b?$.each(a.require,function(d,e){return b[e]?void 0:(c=!1,a.state="X",c)}):c=!1),c};f.$$select=function(a,b){var c,d,e={},g=[],h=0,i=0,j=!0;b&&(f.$wizardAction.selectIndex=a.index),l.triggerHandler("wizard.select",a),$.each(u,function(b,c){c.groupIndex==a.groupIndex&&g.push(c)}),h=g[0].index,i=0==g.length?0:g[g.length-1].index,c="wizard_"+f.$$wizardId+"_"+a.index;var k=function(){return A(),a.active="active",l.find('[wizard-step="'+c+'"]').tab("show"),!1};switch(a.state){case"O":case"L":case"AD":case"OR":k(),j=!1;break;case"X":case"V":j=!1;break;case"A":j=!0;break;default:j=!1}var m=function(a,b,c){var d=[];return $.each(c,function(c,e){e.state!=a&&b==e.groupIndex&&d.push(e)}),d};j&&(e=f.$wizardAction.getParams(),d=C(a,e),d===!1&&(j=!1,l.triggerHandler("wizard.error",{code:"W005"})),B(a.url,e,c,a).success(function(){a.index==h&&k(),a.state="AD"}).success(function(){var b=m("AD",a.groupIndex,g);if(b&&b.length>0){var c=b[0];c.state="A",f.$$select(c,!1)}}))},d(function(){l.triggerHandler("wizard.begin")}),l.on("wizard.restore",function(a,b){f.$$wizardId=b.id;var c=b.item;f.$$select(c,!0,b.data)}),l.on("wizard.done",function(a,b){angular.isFunction(s)&&s({params:{title:b.title,group:b.group,index:b.index}})}),l.on("wizard.choose",function(a,b){f.$$select(b,!0)}),l.on("wizard.select",function(a,b){var c="";switch(b.state){case"X":case"V":c="disable";break;case"AD":case"A":c="editable";break;default:c="readonly"}angular.isFunction(t)&&t({params:{title:b.title,group:b.group,index:b.index,state:c}})}),l.on("wizard.reset",function(){angular.isFunction(r)&&r()}),l.on("wizard.error",function(a,b){var c=g[b.code];throw angular.isFunction(q)&&q({params:{message:c,errorData:b.error||c}}),j.alertMessage("error",c),h.error(b.error||c,k),c}),l.on("wizard.begin",function(){e.bind(f.$wizardAction),angular.isFunction(o)&&o(),v()}),l.on("wizard.end",function(){var a=f.$wizardAction.getParams();angular.isString(n.callbackUrl)?b.get(n.callbackUrl,a).success(function(a){angular.isFunction(p)&&p({params:a})}).error(function(a){l.triggerHandler("wizard.error",{code:"W013",error:a})}):angular.isFunction(p)&&p()})}}}}}])})}(window,document);