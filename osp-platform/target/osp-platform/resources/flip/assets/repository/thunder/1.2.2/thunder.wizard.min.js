/**
 * thunder v1.2.2
 * ===============================
 * Copyright (c) 2014 Far Eastone Telecommunications Co., Ltd.
 * All Rights Reserved.
 * build time: 2015-09-04 11:14:05 
 */
!function(a,b,c){"use strict";define("thunderWizard",["initConfig"],function(){var a=angular.module("thunder.wizard",[]);a.factory("wizardService",["$fetUI",function(){return{registerScope:null,wizards:{},wizardConfigs:{},register:function(a){return this.registerScope=a,this.registerScope.$wizardView={},this.registerScope.$wizardParams={},this.registerScope},bind:function(a){this.wizards[a.key]=a},unbind:function(a){this.wizards[a]=c},get:function(a){return this.wizards[a]||(this.wizards[a]={}),this.wizards[a]}}}]),a.factory("wizardErrorMessage",["$fetUI",function(){var a={"CRM-NSP-005-W001":"Wizard操作錯誤 - 回存資料發生異常","CRM-NSP-005-W002":"Wizard操作錯誤 - 暫存資料發生異常","CRM-NSP-005-W003":"Wizard參數異常錯誤 - WizardInfoId值不存在","CRM-NSP-005-W004":"WizardConfig設定錯誤 - WizardConfig.id不得為空值(null or undefined)","CRM-NSP-005-W005":"Wizard參數異常錯誤 - 未設定require的參數(undefined)","CRM-NSP-005-W006":"Wizard參數異常錯誤 - 找不到wizard索引值","CRM-NSP-005-W007":"Wizard參數異常錯誤 - 找不到wizard群組索引值","CRM-NSP-005-W008":"Wizard參數異常錯誤 - 找不到Step的設定值(404)","CRM-NSP-005-W009":"Wizard參數異常錯誤 - 取得Step的設定值出現錯誤(500)","CRM-NSP-005-W010":"WizardConfig設定錯誤 - 未設定Step,processes需為有長度的Array<Process>","CRM-NSP-005-W011":"WizardConfig設定錯誤 - 未設定儲存Step的URL API","CRM-NSP-005-W012":"WizardConfig設定錯誤 - 未設定回存Step的URL API","CRM-NSP-005-W013":"WizardConfig設定錯誤 - id值不一致","CRM-NSP-005-W014":"Wizard參數異常錯誤 - Wizard回存資料為空值(找不到回存的ID)","CRM-NSP-005-W015":"","CRM-NSP-005-W016":"WizardConfig設定錯誤 - configVersion版本不一致，因此無法正確顯示(回存)的資料","CRM-NSP-005-W017":"Wizard參數異常錯誤 - 未設定下一個步驟的require參數(undefined)，因此無法結束此步驟","CRM-NSP-005-W018":"WizardConfig設定錯誤 - ConfigVersion為必填值，且類別需為Number","CRM-NSP-005-W019":"WizardConfig設定錯誤 - processes群組設定不正確，相同群組需要為連續性的Step","CRM-NSP-005-W020":"Wizard操作錯誤 - 讀取內文發生異常","CRM-NSP-005-W021":"Wizard操作錯誤 - 刪除暫存資料發生異常"};return a}]),a.factory("$wizardAction",["$fetUI","httpService","$timeout","wizardErrorMessage",function(a,b,d,e){return function(d,f,g,h,i,j){var k=f.globalParams,l=f.initParams||{},m=_.assign({},l),n=0,o=function(){var a=0;return _.forEach(g,function(b){return"active"==b.active?!1:void a++}),g[a]},p=function(){return g[n]},q=function(a){var b=_.findIndex(g,function(b){return b.groupIndex==a});return g[b]},r=function(a){var b=[];return _.forEach(g,function(c){c.groupIndex==a&&b.push(c)}),b},s=function(a,b){var c=b||d,e=$('[name="wizard_'+c+"_"+a.index+'"]');e.block({message:null,overlayCSS:{backgroundColor:"#fff",opacity:.4,cursor:"not-allowed"}})},t=function(a){var b=$('[name="wizard_'+d+"_"+a.index+'"]');b.find("a,button").removeClass("disabled"),b.find("input").prop("readonly",!1).prop("disabled",!1),b.unblock()},u=function(a){n=0,_.forEach(g,function(a,b){0===b?(a.state="A",a.selected="true"):a.state="V",a.isDone=!1,a.active="",a.checkCode=!1}),a.setParams({}),a.setData({})},v={key:d,selectIndex:0,paramsArray:new Array(g.length),lock:function(){var a=g[this.selectIndex];"AD"===a.state&&(s(a),a.state="L")},_lockView:function(a,b){s(a,b)},unlock:function(){var a=g[this.selectIndex];"L"===a.state&&(t(a),a.state="AD")},reset:function(){u(this),h.triggerHandler("wizard.reset"),h.triggerHandler("wizard.begin")},next:function(a){var b=o(),c=g.length==b.index?null:g[b.index+1];c&&"V"!=c.state&&"X"!=c.state&&(1==a?b=p():(n=b.index+1,b=g[n]),h.triggerHandler("wizard.choose",b))},_restoreInitParams:function(){m=l},groupNext:function(){var a=o(),b=q(a.groupIndex+1);b&&"V"!=b.state&&"X"!=b.state&&h.triggerHandler("wizard.choose",b)},groupDone:function(a){var b=this,c=o(),d=r(c.groupIndex),f=!0,g=_.keys($.extend({},a)),i=[],j=!1;return _.forEach(d,function(a){a.isDone===!0&&(j=j&&!0)}),1==j?!1:(_.forEach(d,function(a){a.require;_.isArray(a.require)&&(i=_.union(i,_.difference(a.require,g)))}),i.length>0?(e["CRM-NSP-005-W015"]=e["CRM-NSP-005-W005"]+" : "+i.toString(),h.triggerHandler("wizard_error",{code:"CRM-NSP-005-W015"}),!1):(f===!0&&(_.forEach(d,function(a){a.checkCode=!0,a.isDone=!0}),_.forEach(d,function(c){b.setParams(a),b.paramsArray[c.index]=a,b.done(!0),c.isSelected||(c.state="AR")})),b.setParams({}),!0))},done:function(b){function c(a){var b=l;if(n=q.index,_.forEach(a,function(a){a.state="O",s(a),n++}),k.setData(i.$parent.$wizardView),b.groupIndex==j)h.triggerHandler("wizard.end");else{b=p();var c=r(b.groupIndex);_.forEach(c,function(a){a.state="A"})}}function d(a){var b=!0,c=k.getParams(),d=null;return a?(d=a.require,angular.isArray(d)&&d.length>0&&$.each(d,function(a,d){return angular.isUndefined(c[d])?b=!1:void 0}),b):!0}function e(a){var b=!0;return 1==a.length?b:(_.forEach(a,function(a){return a.isDone===!1||angular.isUndefined(a.isDone)?(b=a.isDone===!0?!0:!1,!1):void 0}),b)}var f,k=this,l=o(),m=r(l.groupIndex),q=m[0],t=g.length==l.index?null:g[l.index+1];if(l.checkCode=angular.isUndefined(b)||null===b?!0:a.isTrue(b)?!0:!1,f=1==m.length?l:q,"O"!=f.state&&"OR"!=f.state&&l){var u=!0;l.isDone=!0,e(m)&&u&&(_.forEach(m,function(a){return a.isDone!==!0?u=!1:a.checkCode!==!0?(u=!1,l.isDone=l.checkCode,u):void 0}),1==d(t)&&u?u=!0:(u=!1,l.checkCode=!1,h.triggerHandler("wizard_error",{code:"CRM-NSP-005-W017"})),u===!0&&(l.isDone=l.checkCode,c(m))),h.triggerHandler("wizard.done",{group:l.group,index:l.index,title:l.title})}},save:function(){var e=p(),j=this.paramsArray,k=f.saveUrl,l=this.getData(),m=n;i.$$mode=angular.isUndefined(i.$$wizardInfoId)?"NEW":"UPDATE",m=n==g.length?g.length-1:e.index;for(var o=[],q=0,r=g.length;r>q;q++){var s={};_.forEach(g[q],function(a,b){s[b]=encodeURI(a)}),o.push(s)}var t={};_.forEach(l,function(a,b){t[b]=encodeURI(a)});for(var u=[],q=0,r=i.$items.length;r>q;q++){var s={};_.forEach(j[q],function(a,b){s[b]=encodeURI(a)}),u.push(s)}var v={wizardView:t,id:d,params:u,index:m,groupIndex:e.groupIndex,mode:i.$$mode,processes:o},w={wizardInfoId:i.$$wizardInfoId,wizardInfoData:v,modifyDate:null,enable:null,configVersion:f.configVersion};return k?(h.triggerHandler("wizard_save",v),b.post(k,{data:{data:w},headers:{"Content-Type":"application/json; charset=UTF-8"}}).success(function(b){try{if(a.isTrue(b.errorStatus)===!0)throw w;return i.$$wizardInfoId=b.wizardKey,i.$$mode="UPDATE",e.state="AD",h.triggerHandler("wizard_save_success"),b}catch(c){return e.state="AD",h.triggerHandler("wizard_save_error",c),h.triggerHandler("wizard_error",{code:"CRM-NSP-005-W002",error:c,noThrow:!0}),b}}).error(function(a){e.state="AD",h.triggerHandler("wizard_save_error",a),h.triggerHandler("wizard_error",{code:"CRM-NSP-005-W002",error:a,noThrow:!0})})):(e.state="A",h.triggerHandler("wizard_error",{code:"CRM-NSP-005-W011"}),c)},restore:function(d,e){var g=f.restoreUrl,j={params:{wizardKey:d}},k=this,l="";return u(this),g?(h.triggerHandler("wizard_restore",j.params),b.get(g,j).success(function(b){var d,g,m,o,p,t;try{if(a.isTrue(b.errorStatus)===!0)throw j.params;g=b,m=g.wizardInfoData,o=m.wizardView,p=[],t=m.processes;for(var u=0;u<t.length;u++)_.forEach(t[u],function(a,b){t[u][b]=decodeURI(a)});for(var u=0,v=m.params.length;v>u;u++){var w=m.params[u]||{};_.forEach(w,function(a,b){angular.isUndefined(a)||(w[b]=decodeURI(a))}),_.forEach(e,function(a,b){w[b]=a}),p.push(w)}if(_.forEach(o,function(a,b){o[b]=decodeURI(a)}),g.configVersion!==f.configVersion&&(k.reset(),h.triggerHandler("wizard_error",{code:"CRM-NSP-005-W016"})),null===g||g===c||g.wizardInfoId===c||null===g.wizardInfoId)return l="CRM-NSP-005-W014",h.triggerHandler("wizard_error",{code:l,noThrow:!0}),k.reset(),b;d=q(m.groupIndex),d.state="A",i.$$wizardInfoId=g.wizardInfoId,i.$$mode="UPDATE",k.setData(m.wizardView),k.paramsArray=p,n=d.index;for(var u=m.groupIndex-1;u>=1;u--){var x=r(u);_.forEach(x,function(a){a.state="AR",s(a)})}return m.item=d,h.triggerHandler("wizard_restore_success",m),b}catch(y){return h.triggerHandler("wizard_restore_error",y),k.reset(),h.triggerHandler("wizard_error",{code:"CRM-NSP-005-W001",error:y,noThrow:!0}),b}}).error(function(a){return h.triggerHandler("wizard_restore_error",a),l="404"==a.status?"CRM-NSP-005-W003":"CRM-NSP-005-W001",k.reset(),h.triggerHandler("wizard_error",{code:l,error:a,noThrow:!0}),a})):(l="CRM-NSP-005-W012",k.reset(),h.triggerHandler("wizard_error",{code:l}),c)},setData:function(a){i.$parent.$wizardView||(i.$parent.$wizardView={}),i.$parent.$wizardView=a},addData:function(a,b){var c=this.getData();c[a]=b,this.setData(c)},getData:function(){var a=f.initData||{},b=i.$parent.$wizardView||{},c={};return c=_.assign({},a,b)},setParams:function(a){i.$parent.$wizardParams||(i.$parent.$wizardParams={}),i.$parent.$wizardParams=a},addParams:function(a,b){i.$parent.$wizardParams[a]=b},addInitParams:function(b,c,d){d=a.isTrue(d)===!0?!0:!1,_.isUndefined(l[b])?m[b]=c:d===!0&&(m[b]=c)},getInitParams:function(){return _.assign({},m)},getParams:function(){var a=k||{},b=i.$parent.$wizardParams||{},c={};return c=_.assign(c,a,m,b)}};return v}}]),a.directive("fetWizard",["$fetUI","httpService","$compile","$timeout","wizardService","eventBusService","wizardErrorMessage","loggingService","$wizardAction","modalService",function(a,b,d,e,f,g,h,i,j,k){var l="fetWizard";return{name:l,scope:!0,restrict:"EA",replace:!0,priority:102,transclude:!0,template:"<div role=\"tabpanel\"><ul class=\"wizard color6\" role=\"tablist\"><li ng-repeat=\"item in $items track by $index\" ng-class=\"{active:(item.selected), editable:(item.state=='A' || item.state=='AD'|| item.state=='L'), 'read-only': (item.state=='O' || item.state=='OR'|| item.state=='AR'|| item.state=='RR'), disable: (item.state=='V')}\"><a fet-dom-log log-type=\"TAB\" fet-form-key=\"wizard_{{$$wizardId}}_{{item.id}}_{{item.index}}\" wizard-step=\"wizard_{{$$wizardId}}_{{item.index}}\"   href=\"\" ng-click=\"$$select(item,true)\">{{item.title}}<span class=\"label label-default\"><i class=\"fa\" ng-class=\"{'fa-check-square-o': ((item.checkCode=='true' ||item.checkCode) && (  item.state=='AD' )), 'fa-lock': (item.state=='O'  || item.state=='OR' || item.state=='RR' || item.state=='L' || item.state=='AR'), 'fa-ban': (item.state=='V') }\"></i></span></a></li></ul><div class=\"tab-content\"><div class=\"tab-pane fade in {{item.active}}\" ng-repeat=\"item in $items track by $index\" name=\"wizard_{{$$wizardId}}_{{item.index}}\"  >{{item.title}}</div><div></div></div></div>",compile:function(){var m="NEW",n="UPDATE";return{post:function(o,p,q){var r=a.getScope(o,q,"sWizardConfig"),s=a.getExpression(o,q,"onWizardBegin"),t=a.getExpression(o,q,"onWizardEnd"),u=a.getExpression(o,q,"onWizardError"),v=a.getExpression(o,q,"onWizardReset"),w=a.getExpression(o,q,"onWizardDone"),x=a.getExpression(o,q,"onWizardSelect"),y=a.getExpression(o,q,"onWizardRender"),z=[],A=function(){D=[],o.$items=z,o.$$wizardInfoId=c,o.$$mode=m,p.triggerHandler("wizard.choose",z[0])},B=r.id||q.id||o.$id,C=0,D=[],E=null,F=null;o.$$wizardId=B,r.id||(r.id=B),z=[],angular.isArray(r.processes)&&(z=_.cloneDeep(r.processes));var G=_.uniq(_.pluck(z,"group")),H={};$.each(G,function(a,b){H[b]={},H[b].count=0});var I=function(){_.forEach(o.$items,function(a){a.active=""})},J=function(c,f,g,h,i){var j,k,l,m="",n=o.$wizardAction;return a.uiBlock(p,!0),b.get(c,{params:f}).success(function(a){switch(j=a.type||"html",j=angular.lowercase(j),l=a,0==i&&(n.paramsArray[h.index]=_.assign({},n.paramsArray[h.index]),n.paramsArray[h.index]=_.assign(n.paramsArray[h.index],n.getParams())),j){case"html":k="<div ng-include data-src=\"'"+a.url+"'\"></div>";break;case"iframe":k='<iframe width="100%" height="100%"  frameBorder="0"   ></iframe>',k=$(k).get(0),k.src=a.url;break;case"template":k="<div>"+a.content+"</div>"}return a}).success(function(c){return"apppart"==j&&b.get(l.url,{}).success(function(b){b.config=b.config||{},b.config.$wizardId=B,b.config.$wizardView=o.$parent.$wizardView||{};var c=_.uniqueId("$$appPartConfig");o[c]=b,k='<div app-part src="'+c+'" loadingeffect="\'false\'"></div>',m=d(k)(o),p.find('[name="'+g+'"]').html(m),0==i&&(h.state="AD"),"OR"==h.state&&e(function(){n._lockView(h,o.$$wizardId)}),a.uiBlock(p,!1);b.name}),c}).success(function(b){return m=d(k)(o),p.find('[name="'+g+'"]').html(m),"AR"==h.state&&e(function(){o.$wizardAction._lockView(h,o.$$wizardId)}),0==i&&(h.state="AD"),a.uiBlock(p,!1),b}).success(function(){"template"==j&&e(function(){D[E.index]=!0,p.triggerHandler("wizard.render",E)}),"iframe"==j&&(k.attachEvent?k.attachEvent("onload",function(){D[E.index]=!0,p.triggerHandler("wizard.render",E)}):k.onload=function(){e(function(){D[E.index]=!0,p.triggerHandler("wizard.render",E)})})}).error(function(a){p.triggerHandler("wizard_error",{code:"CRM-NSP-005-W020",error:a})})};$.each(z,function(a,b){var c=b.group;c?(H[c].count++,H[c].count<2&&C++,b.groupIndex=C):(C++,b.groupIndex=C),b.index=a,b.data={},b.state=0!=a?"V":"A"}),o.$on("$includeContentLoaded",function(){D[E.index]!==!0&&(D[E.index]=!0,p.triggerHandler("wizard.render",E))}),o.$$select=function(a,b){var c,d,e={},f=[],g=0,i=0,j=!0,k=o.$wizardAction;E=a,b&&(k.selectIndex=a.index),$.each(z,function(b,c){c.groupIndex==a.groupIndex&&f.push(c)}),g=f[0].index,i=0==f.length?0:f[f.length-1].index,c="wizard_"+o.$$wizardId+"_"+a.index;var l=function(){return I(),a.active="active",p.find('[wizard-step="'+c+'"]').tab("show"),!1};switch(a.state){case"O":case"L":case"AD":case"OR":l(),j=!1;break;case"X":case"V":j=!1;break;case"RR":case"AR":case"A":j=!0,D[a.index]=!1;break;default:j=!1}var m=function(a,b,c){var d=[];return $.each(c,function(c,e){e.state!=a&&"L"!=e.state&&b==e.groupIndex&&d.push(e)}),d};return j?(e=_.assign({},k.paramsArray[a.index]),e=_.assign(e,k.getParams()),d=K(a,e),d.length>0&&(j=!1,h["CRM-NSP-005-W015"]=h["CRM-NSP-005-W005"]+" : "+d.toString(),"AR"!==a.state&&(a.state="A"),p.triggerHandler("wizard_error",{code:"CRM-NSP-005-W015"})),J(a.url,e,c,a,"AR"==a.state).success(function(){if(l(),a.isSelected=!0,"AR"!==a.state?(a.isDone=!1,a.state="AD"):(a.isDone=!0,a.state="OR",k._lockView(a,o.$$wizardId)),"OR"!==a.state){var b=m("AD",a.groupIndex,f);b&&b.length>0&&$.each(b,function(a,b){b.state="A"})}k.setParams({}),p.triggerHandler("wizard.select",a)})):(p.triggerHandler("wizard.select",a),k.setParams({}),null)},o.$wizardAction=j(o.$$wizardId,r,z,p,o,C);var K=function(a,b){var c=[];if(a.require){if(b)return $.each(a.require,function(d,e){angular.isUndefined(b[e])&&(c.push(e),a.state="AR"==a.state?"AR":"X")}),c;c=[]}return c},L=function(a){return{wizardId:o.$$wizardId,processId:(E||{}).id,processIndex:(E||{}).index,eventName:a}};e(function(){p.triggerHandler("wizard.begin"),g.publish("fetWizard","wizard.loaded",{$wizardId:o.$$wizardId})}),p.on("wizard_restore_error",function(a,b){i.error(l,_.assign({},L("WIZARD_RESTORE_ERROR"),{errorTarce:b}))}),p.on("wizard_restore_success",function(a,b){i.info(l,JSON.stringify(L("WIZARD_RESTORE_SUCCESS"))),D=[];var c=b.item;o.$$select(c,!0,b.data),o.$$mode=n}),p.on("wizard_save_error",function(a,b){i.error(l,_.assign({},L("WIZARD_SAVE_ERROR"),{errorTarce:b}))}),p.on("wizard_save",function(a,b){var c=JSON.stringify(_.assign({},L("WIZARD_SAVE"),{data:b}));i.info(l,c)}),p.on("wizard_save_success",function(){i.info(l,JSON.stringify(L("WIZARD_SAVE_SUCCESS")))}),p.on("wizard_restore",function(a,b){var c=JSON.stringify(_.assign({},L("WIZARD_RESTORE"),{data:b}));i.info(l,c)}),p.on("wizard.done",function(a,b){i.info(l,JSON.stringify(L("WIZARD_DONE"))),o.$evalAsync(function(){(w||angular.noop)({params:{title:b.title,group:b.group,index:b.index,id:b.id}})})}),p.on("wizard.choose",function(a,b){o.$$select(b,!0)});var M=function(a){var b;switch(a){case"X":case"V":b="disable";break;case"AD":case"A":b="editable";break;default:b="readonly"}return b};p.on("wizard.select",function(a,b){i.info(l,JSON.stringify(L("WIZARD_SELECT")));var c=M(b.state),d=F&&F.state?M(F.state):"";o.$evalAsync(function(){(x||angular.noop)({params:{title:b.title,group:b.group,index:b.index,state:c,id:b.id,previousId:(F||angular.noop).id,previousTitle:(F||angular.noop).title,previousIndex:(F||angular.noop).index,previousState:d,previousGroup:(F||angular.noop).group}}),F=$.extend({},b)})}),p.on("wizard.render",function(a,b){var c="";i.info(l,JSON.stringify(L("WIZARD_RENDER")));{var c=M(b.state);F&&F.state?M(F.state):""}o.$evalAsync(function(){(y||angular.noop)({params:{title:b.title,group:b.group,index:b.index,state:c,id:b.id}})})}),p.on("wizard.reset",function(){o.$$mode=m,o.$$wizardInfoId=c,D=[],o.$evalAsync(function(){(v||angular.noop)()})}),p.on("wizard_error",function(a,b){var c=h[b.code];if(o.$evalAsync(function(){(u||angular.noop)({params:{message:c,errorData:b.error||c}})}),k.alertMessage("error",c),i.error(l,$.extend({},L("WIZARD_ERROR"),{errorCode:b.code})),b.noThrow!==!0)throw c});var N=function(a){if(_.isArray(a.processes)&&0==a.processes.length)return p.triggerHandler("wizard_error",{code:"CRM-NSP-005-W010",noThrow:!0}),!1;var b=a.configVersion;if(angular.isUndefined(a.configVersion)||isNaN(b)||0>=b)return p.triggerHandler("wizard_error",{code:"CRM-NSP-005-W018",noThrow:!0}),!1;var c={};_.forEach(z,function(a,b){return a.group?void(_.isNumber(c[a.group])||(c[a.group]=b)):!0});var d=!0;return _.forEach(z,function(a){return angular.isUndefined(c[a.group])||null==c[a.group]?!0:c[a.group]!=a.index?d=!1:void c[a.group]++}),0==d&&p.triggerHandler("wizard_error",{code:"CRM-NSP-005-W019",noThrow:!0}),d&&!0};p.on("wizard.begin",function(){f.bind(o.$wizardAction),i.info(l,JSON.stringify(L("WIZARD_BEGIN"))),o.$$mode=m,o.$$wizardInfoId=c,o.$wizardAction._restoreInitParams(),o.$evalAsync(function(){(s||angular.noop)({params:{wizardId:o.$$wizardId}})}),N(r)&&A()}),p.on("wizard.end",function(){o.$$mode=m,o.$$wizardInfoId=c,i.info(l,JSON.stringify(L("WIZARD_END"))),D=[],o.$wizardAction._restoreInitParams(),o.$evalAsync(function(){(t||angular.noop)()})})}}}}}])})}(window,document);